# Phase 1 - Step 21: Observability Events and Audit Correlation (Planning-only)

## 1. Purpose and Scope

This step defines planning-only observability event vocabulary and correlation contracts for Phase 1. It standardizes:

* event naming conventions
* correlation identifiers (correlation_id, request_id, trace_id)
* minimal event fields for logs and metrics
* linkage between operational events and planning audit trail (Step 08)

This document is declarative. It does not mandate a specific logging stack, tracing vendor, metrics backend, or instrumentation framework.

In scope:

* Event taxonomy and names
* Correlation id propagation rules
* Minimal log/metric field vocabulary
* Audit correlation rules (Step 08)
* Error correlation aligned to Step 10

Out of scope:

* Detailed SLO/SLI targets
* Vendor configuration (OpenTelemetry collectors, dashboards)
* Security monitoring and incident response
* Performance optimization guidance

## 2. Authority and Precedence

* Step 01 planning-as-source-of-truth: observability is meta, not authoritative.
* Step 04 API contracts: events relate to API operations.
* Step 08 audit: authoritative record of planning changes.
* Step 10 error taxonomy: error events map to problem details.
* Step 16 concurrency/idempotency: correlation must support retry analysis.
* Step 19 bulk semantics: batch operations require per-item correlation.
* Step 20 rate limits: throttling events must be observable.

If event semantics require product policy (e.g., which fields are PII), STOP and mark DECISION REQUIRED.

## 3. Correlation Identifiers

### 3.1 request_id

* A unique identifier for a single HTTP request.
* Generated by the server if missing.

### 3.2 correlation_id

* A client-supplied identifier spanning multiple requests.
* Used for end-to-end tracing across systems.

### 3.3 trace_id

* A distributed tracing identifier (e.g., W3C traceparent).
* May be derived from tracing instrumentation.

### 3.4 Propagation Rules

* Clients MAY provide correlation_id.
* Server MUST return request_id.
* If trace_id is present, it SHOULD be returned.

Recommended headers (illustrative):

* X-Request-Id
* X-Correlation-Id
* traceparent (W3C)

Phase 1 does not mandate header names; it mandates semantics.

## 4. Event Naming Conventions

### 4.1 Format

* domain.action.result

Where:

* domain: planning
* action: read|list|create|update|transition|archive|import|export|batch
* result: success|failed|throttled

Examples:

* planning.create.success
* planning.update.failed
* planning.transition.failed
* planning.batch.success
* planning.import.failed
* planning.read.throttled

### 4.2 Resource Subtype (Optional)

If needed, append resource type:

* planning.mission.update.success
* planning.assignment.transition.failed

## 5. Minimal Event Fields

All events SHOULD include:

* timestamp_utc
* event_name
* request_id
* correlation_id (if known)
* trace_id (if known)
* actor_kind (symbolic; e.g., user, system)
* actor_id (optional; may be redacted)
* scope: { organization_id, project_id }
* resource_type (optional)
* resource_id (optional)
* operation (HTTP method or bulk operation)
* result
* duration_ms (optional)

### 5.1 Error Fields

For failed events:

* error_code (from Step 10)
* http_status
* error_category (validation, conflict, concurrency, authz, throttling)

### 5.2 Retry and Idempotency Fields

When relevant:

* idempotency_key_present: boolean
* idempotency_key_hash (optional, privacy-safe)
* if_match_present: boolean

## 6. Metrics Vocabulary (Planning-only)

Metrics are named and tagged consistently.

Recommended metric names (illustrative):

* planning_requests_total
* planning_requests_duration_ms
* planning_errors_total
* planning_conflicts_total
* planning_batch_items_total
* planning_rate_limited_total

Recommended labels/tags:

* action
* resource_type
* result
* http_status
* error_code
* organization_id (optional, may be high-cardinality)
* project_id (optional, may be high-cardinality)

DECISION REQUIRED: whether high-cardinality labels are permitted.

## 7. Audit Correlation (Step 08 Linkage)

### 7.1 From Operational Event to Audit Event

When a write succeeds and an audit event is created (Step 08), the audit event SHOULD capture:

* request_id
* correlation_id
* trace_id
* idempotency key presence (not raw key)

This enables linking logs/traces to authoritative planning changes.

### 7.2 From Audit Event to Operational Context

Operational logs SHOULD log the resulting audit_event_id (if available) on write success.

DECISION REQUIRED: whether audit_event_id is exposed in API responses.

## 8. Bulk and Import/Export Correlation

### 8.1 Bulk (Step 19)

* Batch operation event includes request-level correlation.
* Each item success/failure MAY emit an item-level event including:

  * item_id
  * resource_id
  * per-item result

### 8.2 Import/Export (Step 17)

* Export events include:

  * export_type
  * format_version
  * snapshot_id (if present)

* Import events include:

  * mode (dry_run|apply)
  * strategy
  * created/updated counts

## 9. Throttling and Abuse Events (Step 20)

When rate limited:

* emit planning.*.throttled
* include Retry-After if present
* include limit_scope and limit_type (read/write/bulk) where known

## 10. Privacy and Redaction (Planning-only)

Phase 1 requires:

* avoid logging full payloads by default
* do not log raw Idempotency-Key values
* allow redaction of actor_id and high-cardinality scope ids

DECISION REQUIRED: what fields are considered PII and must always be redacted.

## 11. Validation Checklist

Before implementation work proceeds:

* Event names cover all primary planning actions.
* Correlation identifiers have clear propagation semantics.
* Error fields map to Step 10 codes.
* Audit events can be correlated to operational events via request_id/correlation_id.
* Bulk and import/export correlation is consistent with Steps 19 and 17.
* Rate limit events align with Step 20.
